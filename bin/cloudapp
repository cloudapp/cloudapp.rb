#!/usr/bin/env ruby

require 'formatador'
require 'main'

# Explicitly require yaml because ruby 1.9.2 (and greater?) define YAML which
# causes main to not require it.
require 'yaml'

require 'cloudapp/drop_service'
require 'ostruct'

Main do
  def identity
    OpenStruct.new email:    config[:email], password: config[:password]
  end

  def service
    CloudApp::DropService.as_identity(identity).tap do |service|
      service.logger.level = Logger::WARN
    end
  end

  config email: 'arthur@dent.com', password: 'towel'

  mode :new do

    # Bookmark a link: `cloudapp new bookmark http://getcloudapp.com`
    mode :bookmark do
      argument('url') { cast :uri }

      def run
        response = service.create url: params[:url].value
        puts response.fetch 'url'
      end
    end

    # Share a file: `cloudapp new file screenshot.png`
    mode :file do
      argument('file') { cast :pathname }

      def run
        response = service.create path: params[:file].value
        puts response.fetch 'url'
      end
    end
  end

  # List newest drops: `cloudapp list [--count=5]`
  mode :list do
    option 'count', 'n' do
      argument :optional
      cast :integer
      default 20
    end

    def run
      count = params[:count].value
      drops = service.drops count

      name_width  = drops.map {|drop| drop['name'].size }.max
      views_width = [ 5, drops.map {|drop| drop['view_counter'].to_s.size }.max ].max
      link_width  = drops.map {|drop| drop['url'].size }.max

      header = [ "[bold]#{ 'Name' .ljust(name_width)   }[/]",
                 "[bold]#{ 'Link' .ljust(link_width)   }[/]",
                 "[bold]#{ 'Views'.center(views_width) }[/]" ].join(' ')
      Formatador.display_line header

      lines = drops.map do |drop|
        [ drop['name'].ljust(name_width),
          drop['url'],
          drop['view_counter'].to_s.center(views_width)
        ].join ' '
      end

      Formatador.display_lines lines
    end
  end

end
