#!/usr/bin/env ruby

require 'formatador'
require 'main'

# Explicitly require yaml because ruby 1.9.2 (and greater?) define YAML which
# causes main to not require it.
require 'yaml'

require 'cloudapp/identity'
require 'cloudapp/drop_service'

Main do
  def identity
    CloudApp::Identity.from_config config
  end

  def service
    CloudApp::DropService.as_identity(identity).tap do |service|
      service.logger.level = Logger::WARN
    end
  end

  config email: 'arthur@dent.com', password: 'towel'

  # Bookmark a link: `cloudapp bookmark http://getcloudapp.com`
  mode :bookmark do
    argument('url') { cast :uri }

    def url
      params[:url].value
    end

    def run
      Formatador.display "Bookmarking #{ url }..."

      response = service.create url: url
      Formatador.display_line response.fetch 'url'
    end
  end

  # Upload a file: `cloudapp upload screenshot.png`
  mode :upload do
    argument('file') { cast :pathname }

    def file
      params[:file].value
    end

    def run
      Formatador.display "Uploading #{ file }..."

      response = service.create path: file
      Formatador.display_line response.fetch 'url'
    end
  end

  # List newest drops: `cloudapp list [--count=5]`
  mode :list do
    option 'count', 'n' do
      argument :optional
      cast :integer
      default 20
    end

    def run
      count = params[:count].value
      drops = service.drops count

      name_width  = drops.map {|drop| drop['name'].to_s.size }.max
      views_width = [ 5, drops.map {|drop| drop['view_counter'].to_s.size }.max ].max
      link_width  = drops.map {|drop| drop['url'].size }.max

      header = [ "[bold]#{ 'Name' .ljust(name_width)   }[/]",
                 "[bold]#{ 'Link' .ljust(link_width)   }[/]",
                 "[bold]#{ 'Views'.center(views_width) }[/]" ].join(' ')
      Formatador.display_line header

      lines = drops.map do |drop|
        [ drop['name'].to_s.ljust(name_width),
          drop['url'],
          drop['view_counter'].to_s.center(views_width)
        ].join ' '
      end

      Formatador.display_lines lines
    end
  end

end
